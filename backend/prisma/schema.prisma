// ---------------------------------------------
// Prisma schema for "Polls App" (MVP/test)
// Models reflect the API contract v1 and specs.
// - DB: PostgreSQL
// - Auth: JWT (users are seeded, no signup endpoint)
// - Rating: integer 1..5
// - Invariants from API: unique (userId, pollId); vote allowed only if poll is OPEN
// ---------------------------------------------

// Datasource & generator
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ---------------------------------------------
// Enums
// ---------------------------------------------

// Role allowed by the app-level authorization rules.
// - 'user': can list polls, read details, cast/update vote on OPEN polls
// - 'admin': can create polls and close them
enum Role {
  user
  admin
}

// Poll lifecycle state
// - OPEN: votes can be created/updated
// - CLOSED: votes are blocked; avg/count remain query-based
enum PollStatus {
  OPEN
  CLOSED
}

// ---------------------------------------------
// Models
// ---------------------------------------------

// Application user seeded for the test/MVP.
// Passwords are stored as a secure hash (e.g., bcrypt/argon2).
model User {
  // Primary key (string IDs let us stay flexible; client defaults to cuid()).
  id           String   @id @default(cuid())

  // Unique email used for login.
  email        String   @unique

  // Password hash (bcrypt or argon2). Never expose in API responses.
  passwordHash String

  // Application role: 'user' or 'admin'.
  role         Role     @default(user)

  // Audit fields
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  polls        Poll[]   @relation("UserPolls") // polls created by this user
  votes        Vote[]   // votes cast by this user
}

// A poll that users can rate (1..5).
model Poll {
  id         String      @id @default(cuid())

  // Human-readable title shown in listings and details.
  title      String

  // OPEN -> voting allowed; CLOSED -> voting blocked.
  status     PollStatus  @default(OPEN)

  // Creator (must be an admin according to app-level rules).
  createdBy  String
  createdAt  DateTime    @default(now())

  // Relations
  author     User        @relation("UserPolls", fields: [createdBy], references: [id], onDelete: Cascade)
  votes      Vote[]

  // Helpful indexes for lookups and ordering
  @@index([status])
  @@index([createdAt])
}

// A user's rating on a given poll (1-5).
model Vote {
  id        String   @id @default(cuid())

  // FK to Poll
  pollId    String
  // FK to User
  userId    String

  // Rating in [1-5]. The API contract enforces integer range.
  rating    Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  poll      Poll     @relation(fields: [pollId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Each user can vote a poll at most once (upsert on POST /polls/:id/vote).
  @@unique([userId, pollId])

  // Fast aggregations/scans by poll
  @@index([pollId])
}